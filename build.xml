<?xml version="1.0" encoding="UTF-8"?>

<project name="glow" default="all" basedir=".">

	<property file="build.properties" />
	<property name="BUILD_DIR" value="build/${VERSION}" />
	<property name="DIST_DIR" value="dist/${VERSION}" />
	<property name="JSDOC_JAR" value="${JSDOC_DIR}/jsrun.jar" />
	<property name="JSDOC_TPL" value="jsdoc/buildlates/jsdoc" />
	<xmlproperty file="packages/packages.xml" collapseAttributes="true" />
	
	<target name="setup">
		<delete dir="${BUILD_DIR}" />
		<mkdir dir="${BUILD_DIR}" />
		
		<delete dir="${DIST_DIR}" />
		<mkdir dir="${DIST_DIR}" />
	</target>
	
	<target name="meta">
		<tstamp>
			<format property="BUILT_DATE" pattern="d MMMM yyyy hh:mm aa" offset="0" unit="hour" locale="en,UK" />
		</tstamp>
		<echo file="${BUILD_DIR}/../meta.js" append="false">
			meta({ version: '${VERSION}', buildDate: '${BUILT_DATE}' });
		</echo>
	</target>
	
	<target name="knit">
		<concat destfile="${BUILD_DIR}/glow.js" fixlastline="yes" eol="lf">
			<filelist files="${packages.glow.js.file}" />
		</concat>
		
		<concat destfile="${BUILD_DIR}/core.js" fixlastline="yes" eol="lf">
			<filelist files="${packages.core.js.file}" />
		</concat>
		
		<concat destfile="${BUILD_DIR}/widgets.js" fixlastline="yes" eol="lf">
			<filelist files="${packages.widgets.js.file}" />
		</concat>
		
		<concat destfile="${BUILD_DIR}/widgets.css" fixlastline="yes" eol="lf">
			<filelist files="${packages.widgets.css.file}" />
		</concat>
	</target>
	
	<target name="filter" depends="knit">
		<!-- add version number -->
		<replace dir="${BUILD_DIR}" includes="**/*.js,**/*.css">
		   <replacefilter token="@SRC@" value="${VERSION}" />
		</replace>
		
		<!-- evaluate includes -->
		<loadfile property="include.glowbug.js" srcfile="src/include/glowbug.js"/>
		<replaceregexp match="/\*!include:glowbug\.js\*/" flags="g">
			<substitution expression="${include.glowbug.js}"/>
			<fileset dir="${DIST_DIR}" includes="**/*.js,**/*.css"/>
		</replaceregexp>
	</target>
	
	<target name="debug" depends="filter">
		<copy todir="${DIST_DIR}">
			<fileset dir="${BUILD_DIR}">
				<include name="**/*.js" />
				<include name="**/*.css" />
			</fileset>
			<mapper type="regexp" from="(.*)\.(js|css)" to="\1.debug.\2"/>
		</copy>
	</target>
	
	<target name="minify" depends="filter">
		<!-- remove debugging code -->
		<replaceregexp match="/\*!debug\*/.*?/\*gubed!\*/" flags="gs" replace="">
			<fileset dir="${BUILD_DIR}" includes="**/*.js"/>
		</replaceregexp>
		
		<!-- compile -->
		<exec executable="java" failonerror="true">
			<arg value="-jar"/>
			<arg value="compiler.jar" />
			<arg value="--module_output_path_prefix"/>
			<arg value="${BUILD_DIR}/"/>
			<arg value="--js"/>
			<arg value="${BUILD_DIR}/glow.js"/>
			<arg value="--module"/>
			<arg value="glow:1"/>
			<arg value="--js"/>
			<arg value="${BUILD_DIR}/core.js"/>
			<arg value="--module"/>
			<arg value="core:1:glow"/>
			<arg value="--js"/>
			<arg value="${BUILD_DIR}/widgets.js"/>
			<arg value="--module"/>
			<arg value="widgets:1:glow,core"/>
			
			<!--arg value="-
			-compilation_level" />
			<arg value="ADVANCED_OPTIMIZATIONS" /-->
		</exec>
	</target>
	
	<target name="deploy" depends="minify">
		<!-- copy to dist -->
		<copy todir="${DIST_DIR}">
			<fileset dir="${BUILD_DIR}">
				<include name="**/*.js" />
				<include name="**/*.css" />
			</fileset>
		</copy>
	</target>
	
	<target name="apidocs">
		<delete dir="/docs/${LINE}"/>
		<mkdir dir="/docs/${LINE}" />		
		<exec executable="java" failonerror="true">
			<arg value="-jar"/>
	                <arg value="${JSDOC_JAR}"/>
			<arg value="${JSDOC_DIR}/app/run.js" />
			<arg value="-n" />
			<arg value="-t=${JSDOC_TPL}/" />
			<arg value="-d=docs/${LINE}/" />
			<arg value="-r=4" />			
			<arg value="src/" />
		</exec>
	</target>
	
	<target name="all" depends="setup, meta, knit, filter, debug, minify, deploy">
		<echo message="" />
		<echo message="**************************************" />
		<echo message="Glow version ${VERSION} build complete" />
		<echo message="**************************************" />
		<echo message="" />
	</target>
	
</project>
