<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>test: glow</title>
	
	<script src="qunit.js" type="text/javascript"></script>
	<link rel="stylesheet" rev="stylesheet" href="qunit.css" type="text/css" media="screen">

	<script src="../../src/glow.js" type="text/javascript"></script>
	
	<script type="text/javascript">
		testHelper = {
			getScriptTagsBySrc: function(src) {
				var scriptTags = document.getElementsByTagName('script');
				var found = [];
				for (var i = 0, len = scriptTags.length; i < len; i++) {
					if ( scriptTags[i].src.indexOf(src) > -1 ) {
						found.push(scriptTags[i]);
					}
				}
				return found;
			}
		}
	</script>
	
	<script type="text/javascript">
		module('Glow');
		
		test('resolveVersion', function() {
			expect(5);
			
			// setup
			var originalVersions = Glow.versions;
			Glow.versions = ['2.0.0 rc-1', '2.0.0', '2.0.1', '2.1.0 rc-1', '2.1.0'];
		
			var glow = Glow('2');
		
				ok( (glow !== undefined), 'glow is defined.' );
				equals(glow.version, '2.1.0', 'glow.version is set to the latest minor+bugfix version.');
			
			glow = Glow('2.0');
			
				equals(glow.version, '2.0.1', 'glow.version is set to the latest bugfix version.');
			
			glow = Glow('2.1.0 rc-1');
			
				equals(glow.version, '2.1.0 rc-1', 'glow.version is set to the latest exact version.');
			
			try { glow = Glow('3'); }
			catch(e) {
				ok( true, 'an undefined version throws an error.' );
			}
			
			// tear down
			Glow.versions = originalVersions;
		});
		
		var providedGlow = Glow('src'); // set up for the next test
	</script>
	
	<!-- script will be added dynamically in the load() test -->
	<script src="../../src/lang/lang.js" type="text/javascript"></script>

	<script type="text/javascript">
		
		test('provide', function() {
			expect(6);
			
			ok( (Glow.instances['src'] !== undefined), 'reference to src glow instance is defined.' );
			ok( (Glow.instances['src'].lang !== undefined), 'namespace lang is defined there.' );
			ok( (Glow.instances['src'].lang.trim !== undefined), 'method lang.trim is defined there.' );
			ok( (Glow.instances['src'].lang.toArray !== undefined), 'method lang.toArray is defined there.' );
			
			ok( (providedGlow.lang !== undefined), 'my instance of glow has the module defined.' );
			
			var trimmed = providedGlow.lang.trim("  Hello World  ");
			equals( trimmed, 'Hello World', 'my instance of glow has module methods that can be called.' );
			
		});
		
		test('load and loaded', function() {
			expect(6);
			
			Glow.instances = {}; // reset
			Glow.packages = {};  // reset
			var myGlow = Glow('src');
			
			stop(); // wait for core package to be available
			
			myGlow.base = '/projects/glow2/';
			// multiple loads of the same package should not add multiple script tags to the page
			myGlow.load('core').loaded(function(glow) { /*debug*///console.log('loaded callback invoked.');
				start();
			
				ok( true, 'loaded callback is invoked.' );
				ok( glow, 'loaded callback receives a glow argument.' );
				ok( glow.lang, 'loaded callback receives a glow argument which has been populated by provide.' );
				
				// we should invoke this loaded callback immediately because the package is already avilable
				myGlow.load('core');
				myGlow.loaded(function(glow) {
					ok( true, 'second loaded callback is invoked.' );
					ok( glow.lang, 'second loaded callback receives a glow argument which has been populated.' );
					
					// count how many script tags were added for core (should be 1)
					coreScriptTags = testHelper.getScriptTagsBySrc(myGlow.base + 'src/core.js');
					equals(coreScriptTags.length, 1, 'a script tag with the correct src is injected by load(), but only once.' );
				});
			});
		});
	</script>

</head>
<body>
	<h1 id="qunit-header">Unit Tests: glow.js</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
</body>
</html>
